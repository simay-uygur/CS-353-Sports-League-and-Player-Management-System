<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Create Tournament</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
    <main class="dashboard-container">
        <header class="admin-header">
            <div>
                <p class="eyebrow">Admin Console</p>
                <h1>Create Tournament</h1>
            </div>
            <div class="admin-actions">
                <div class="admin-icons">
                    <span class="icon-button" title="Notifications">ðŸ””</span>
                    <span class="icon-button" title="Profile">ðŸ‘¤</span>
                </div>
            </div>
        </header>

        <section class="create-layout">
            <form class="create-card" method="POST" novalidate>
                <div class="create-card-inner">
                   

                    {% if error_message %}
                    <div class="form-message error">{{ error_message }}</div>
                    {% else %}
                    <p class="form-note">Fill out the details below to create a tournament. Select the teams you want to includeâ€”bracket rounds are generated automatically.</p>
                    {% endif %}

                    <label for="tournament_name">Tournament Name</label>
                    <input type="text"
                           id="tournament_name"
                           name="tournament_name"
                           placeholder="Tournament Name"
                           required
                           value="{{ form_data.get('tournament_name', '') }}">

                    <label for="tournament_start_date">Tournament Start Date</label>
                    <input type="date"
                           id="tournament_start_date"
                           name="tournament_start_date"
                           required
                           value="{{ form_data.get('tournament_start_date', '') }}">

                    {% if admins %}
                    <label>Assign Admins</label>
                    <p class="select-hint subtle">Selected admins will moderate this tournament.</p>
                    <div class="admin-picker">
                        <div class="search-box">
                            <input type="search"
                                   id="admin-search"
                                   placeholder="Search admins by name or email"
                                   aria-label="Search admins">
                        </div>
                        <div class="checkbox-list" id="admin-checkbox-list">
                            {% for admin in admins %}
                            <label class="checkbox-line" data-admin-search="{{ (admin.firstname ~ ' ' ~ admin.lastname ~ ' ' ~ admin.email)|lower }}">
                                <input type="checkbox"
                                       name="moderator_ids"
                                       value="{{ admin.usersid }}"
                                       {% if admin.usersid|string in selected_admin_ids %}checked{% endif %}>
                                <span>{{ admin.firstname }} {{ admin.lastname }} ({{ admin.email }})</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <label>Select Teams</label>
                    <div class="admin-picker">
                        <div class="search-box">
                            <input type="search"
                                   id="team-search"
                                   placeholder="Search teams"
                                   aria-label="Search teams">
                        </div>
                        <div class="checkbox-list" id="team-checkbox-list">
                            {% for team in teams %}
                            <label class="checkbox-line" data-team-search="{{ team.teamname|lower }}">
                                <input type="checkbox"
                                       name="team_ids"
                                       value="{{ team.teamid }}"
                                       {% if team.teamid|string in selected_team_ids %}checked{% endif %}>
                                <span>{{ team.teamname }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <p class="select-hint">Selected: <span id="selected-count">{{ selected_team_ids|length }}</span></p>
                        <p class="select-hint error" id="team-validation" aria-live="polite"></p>
                    </div>

                    <div class="form-action-buttons">
                        <button type="button"
                                class="btn ghost leave-link"
                                data-target="{{ url_for(cancel_endpoint) }}"
                                data-confirm-message="Leave without creating this tournament?">
                            Cancel
                        </button>
                        <button type="submit" class="btn solid">Save</button>
                    </div>
                </div>
            </form>

        </section>
    </main>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const leaveTriggers = document.querySelectorAll(".leave-link");
        const teamSearch = document.getElementById("team-search");
        const teamCheckboxList = document.getElementById("team-checkbox-list");
        const teamRows = teamCheckboxList ? Array.from(teamCheckboxList.querySelectorAll(".checkbox-line")) : [];
        const selectedCountEl = document.getElementById("selected-count");
        const form = document.querySelector(".create-card");
        const adminSearch = document.getElementById("admin-search");
        const adminCheckboxList = document.getElementById("admin-checkbox-list");
        const adminRows = adminCheckboxList ? Array.from(adminCheckboxList.querySelectorAll(".checkbox-line")) : [];
        const teamValidation = document.getElementById("team-validation");

        leaveTriggers.forEach(function (el) {
            el.addEventListener("click", function (event) {
                const message = el.dataset.confirmMessage || "Leave without creating the tournament?";
                if (!confirm(message)) {
                    event.preventDefault();
                    return;
                }
                if (el.dataset.target) {
                    window.location.href = el.dataset.target;
                }
            });
        });

        function getSelectedCount() {
            if (!teamCheckboxList) return 0;
            return teamCheckboxList.querySelectorAll('input[name="team_ids"]:checked').length;
        }

        function isPowerOfTwo(value) {
            return value > 0 && (value & (value - 1)) === 0;
        }

        function updateSelectedCount() {
            const count = getSelectedCount();
            if (selectedCountEl) selectedCountEl.textContent = count;
            if (teamValidation) {
                if (count === 0) {
                    teamValidation.textContent = "";
                } else if (count < 2) {
                    teamValidation.textContent = "Select at least two teams.";
                } else if (!isPowerOfTwo(count)) {
                    teamValidation.textContent = "Team count must be a power of 2 (2, 4, 8, 16, ...).";
                } else {
                    teamValidation.textContent = "";
                }
            }
        }

        function filterAdmins(query) {
            const normalized = (query || "").toLowerCase().trim();
            adminRows.forEach(function (row) {
                const haystack = (row.dataset.adminSearch || row.innerText || "").toLowerCase();
                const match = !normalized || haystack.includes(normalized);
                row.classList.toggle("is-hidden", !match);
            });
        }

        if (adminSearch && adminCheckboxList) {
            adminSearch.addEventListener("input", function (event) {
                filterAdmins(event.target.value);
            });
            filterAdmins("");
        }

        function filterTeams(query) {
            const normalized = (query || "").toLowerCase().trim();
            teamRows.forEach(function (row) {
                const haystack = (row.dataset.teamSearch || row.innerText || "").toLowerCase();
                const match = !normalized || haystack.includes(normalized);
                row.classList.toggle("is-hidden", !match);
            });
        }

        if (teamSearch && teamCheckboxList) {
            teamSearch.addEventListener("input", function (event) {
                filterTeams(event.target.value);
            });
            filterTeams("");
        }

        if (teamCheckboxList) {
            teamCheckboxList.addEventListener("change", updateSelectedCount);
        }

        updateSelectedCount();

        if (form) {
            form.addEventListener("submit", function (event) {
                const selectedCount = getSelectedCount();
                if (selectedCount < 2) {
                    event.preventDefault();
                    alert("Please select at least two teams to create a tournament.");
                    return;
                }
                if (!isPowerOfTwo(selectedCount)) {
                    event.preventDefault();
                    alert("Please select a power of 2 number of teams (2, 4, 8, 16, ...).");
                }
            });
        }
    });
</script>
</html>
