<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="dashboard-body">
    {% include "_banner.html" %}
    <main class="dashboard-container">
        <header class="admin-header">
            <div>
                <p class="eyebrow">Admin Console</p>
                <h1>Reports</h1>
                {% if error_message %}
                <p class="form-message error">{{ error_message }}</p>
                {% endif %}
            </div>
        </header>

        <section class="reports-grid">
            <div class="card">
                <h3>Player Report</h3>
                <form method="POST">
                    <input type="hidden" name="report_type" value="players">
                    <div class="filter-group-complete">
                        <label for="player_search">Players (optional)</label>
                        <input type="search"
                               id="player_search"
                               class="player-search"
                               placeholder="Search players"
                               aria-label="Search players">
                        <div class="checkbox-list player-checkbox-list">
                            {% for player in players %}
                                <label class="checkbox-line" data-player-search="{{ (player.firstname ~ ' ' ~ player.lastname)|lower }}">
                                    <input type="checkbox"
                                           name="player_id"
                                           value="{{ player.playerid }}"
                                           {% if request.form.getlist('player_id') and player.playerid|string in request.form.getlist('player_id') %}checked{% endif %}>
                                    <span>{{ player.firstname }} {{ player.lastname }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <label class="checkbox-field">
                        <input type="checkbox" name="currently_employed">
                        <span>Currently employed</span>
                    </label>

                    <label>Employment start date before</label>
                    <input type="datetime-local" name="employed_before" value="{{ request.form.get('employed_before','') }}">

                    <label>Employment start date after</label>
                    <input type="datetime-local" name="employed_after" value="{{ request.form.get('employed_after','') }}">

                    <label>Employment end date before</label>
                    <input type="datetime-local" name="ended_before" value="{{ request.form.get('ended_before','') }}">

                    <label>Employment end date after</label>
                    <input type="datetime-local" name="ended_after" value="{{ request.form.get('ended_after','') }}">

                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Performance Filters (minimum values)</p>

                    <label>Min Goals</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_goals" placeholder="e.g. 5" value="{{ request.form.get('min_goals','') }}">

                    <label>Min Assists</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_assists" placeholder="e.g. 3" value="{{ request.form.get('min_assists','') }}">

                    <label>Min Appearances</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_appearances" placeholder="e.g. 10" value="{{ request.form.get('min_appearances','') }}">

                    <label>Min Yellow Cards</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_yellow_cards" placeholder="e.g. 2" value="{{ request.form.get('min_yellow_cards','') }}">

                    <label>Min Red Cards</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_red_cards" placeholder="e.g. 1" value="{{ request.form.get('min_red_cards','') }}">

                    <label>Min Saves</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="min_saves" placeholder="e.g. 5" value="{{ request.form.get('min_saves','') }}">

                    <button type="submit" class="btn solid">Generate</button>
                </form>
            </div>

            <div class="card">
                <h3>League Standings</h3>
                <form method="POST">
                    <input type="hidden" name="report_type" value="standings">
                    <label>League</label>
                    <select name="league_id" class="form-select" required>
                        <option value="">Select league</option>
                        {% for l in leagues %}
                        <option value="{{ l.leagueid }}" {% if request.form.get('league_id') == l.leagueid|string %}selected{% endif %}>{{ l.name }}</option>
                        {% endfor %}
                    </select>
                    <label>Season No (optional)</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" name="season_no" placeholder="Optional" value="{{ request.form.get('season_no','') }}">
                    <label>Season Year (optional)</label>
                    <input type="date" name="season_year" placeholder="Optional" value="{{ request.form.get('season_year','') }}">
                    <button type="submit" class="btn solid">Generate</button>
                </form>
            </div>

            <div class="card">
                <h3>Training Attendance</h3>
                <form method="POST">
                    <input type="hidden" name="report_type" value="attendance">
                    <label>Date From (optional)</label>
                    <input type="date" name="date_from" value="{{ request.form.get('date_from','') }}">
                    <label>Date To (optional)</label>
                    <input type="date" name="date_to" value="{{ request.form.get('date_to','') }}">
                    <div class="filter-group-complete">
                        <label for="attendance_player_search">Players (optional)</label>
                        <input type="search"
                               id="attendance_player_search"
                               class="attendance-player-search"
                               placeholder="Search players"
                               aria-label="Search players">
                        <div class="checkbox-list attendance-player-checkbox-list">
                            {% for player in players %}
                                <label class="checkbox-line" data-attendance-player-search="{{ (player.firstname ~ ' ' ~ player.lastname)|lower }}">
                                    <input type="checkbox"
                                           name="player_id"
                                           value="{{ player.playerid }}"
                                           {% if request.form.getlist('player_id') and player.playerid|string in request.form.getlist('player_id') %}checked{% endif %}>
                                    <span>{{ player.firstname }} {{ player.lastname }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    <label>Team (optional)</label>
                    <select name="team_id" class="form-select">
                        <option value="">All teams</option>
                        {% for t in teams %}
                        <option value="{{ t.teamid }}" {% if request.form.get('team_id') == t.teamid|string %}selected{% endif %}>{{ t.teamname }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn solid">Generate</button>
                </form>
            </div>
        </section>

        {% if players_report is not none %}
        <section class="report-table">
            <h3>Player Report Results</h3>
            {% if players_report %}
            <div class="report-actions">
                <form method="POST" action="{{ url_for('admin.download_report_pdf') }}" class="inline-form">
                    <input type="hidden" name="report_type" value="players">
                    {% for player_id in request.form.getlist('player_id') %}
                    <input type="hidden" name="player_id" value="{{ player_id }}">
                    {% endfor %}
                    <input type="hidden" name="currently_employed" value="{{ 1 if request.form.get('currently_employed') else '' }}">
                    <input type="hidden" name="employed_before" value="{{ request.form.get('employed_before', '') }}">
                    <input type="hidden" name="employed_after" value="{{ request.form.get('employed_after', '') }}">
                    <input type="hidden" name="ended_before" value="{{ request.form.get('ended_before', '') }}">
                    <input type="hidden" name="ended_after" value="{{ request.form.get('ended_after', '') }}">
                    <input type="hidden" name="min_goals" value="{{ request.form.get('min_goals', '') }}">
                    <input type="hidden" name="min_assists" value="{{ request.form.get('min_assists', '') }}">
                    <input type="hidden" name="min_appearances" value="{{ request.form.get('min_appearances', '') }}">
                    <input type="hidden" name="min_yellow_cards" value="{{ request.form.get('min_yellow_cards', '') }}">
                    <input type="hidden" name="min_red_cards" value="{{ request.form.get('min_red_cards', '') }}">
                    <input type="hidden" name="min_saves" value="{{ request.form.get('min_saves', '') }}">
                    <button type="submit" class="btn solid btn-small">Download PDF</button>
                </form>
            </div>
            <div class="table-card">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Position</th>
                            <th>Team</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Goals</th>
                            <th>Assists</th>
                            <th>Apps</th>
                            <th>YC</th>
                            <th>RC</th>
                            <th>Saves</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in players_report %}
                        <tr>
                            <td>{{ p.firstname }} {{ p.lastname }}</td>
                            <td>{{ p.email }}</td>
                            <td>{{ p.position }}</td>
                            <td>{{ p.teamname or 'Unassigned' }}</td>
                            <td>{{ p.startdate|strftime('%Y-%m-%d') if p.startdate else '' }}</td>
                            <td>{{ p.enddate|strftime('%Y-%m-%d') if p.enddate else '' }}</td>
                            <td>{{ p.total_goals or 0 }}</td>
                            <td>{{ p.total_assists or 0 }}</td>
                            <td>{{ p.total_appearances or 0 }}</td>
                            <td>{{ p.total_yellowcards or 0 }}</td>
                            <td>{{ p.total_redcards or 0 }}</td>
                            <td>{{ p.total_saves or 0 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="subtle">No results.</p>
            {% endif %}
        </section>
        {% endif %}

        {% if standings_report is not none %}
        <section class="report-table">
            <h3>League Standings</h3>
            {% if standings_report %}
            <div class="report-actions">
                <form method="POST" action="{{ url_for('admin.download_report_pdf') }}" class="inline-form">
                    <input type="hidden" name="report_type" value="standings">
                    <input type="hidden" name="league_id" value="{{ request.form.get('league_id', '') }}">
                    <input type="hidden" name="season_no" value="{{ request.form.get('season_no', '') }}">
                    <input type="hidden" name="season_year" value="{{ request.form.get('season_year', '') }}">
                    <button type="submit" class="btn solid btn-small">Download PDF</button>
                </form>
            </div>
            <div class="table-card">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>Pts</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in standings_report %}
                        <tr>
                            <td>{{ row.teamname }}</td>
                            <td>{{ row.points }}</td>
                            <td>{{ row.wins }}</td>
                            <td>{{ row.draws }}</td>
                            <td>{{ row.losses }}</td>
                            <td>{{ row.gf }}</td>
                            <td>{{ row.ga }}</td>
                            <td>{{ row.gf - row.ga }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="subtle">No results.</p>
            {% endif %}
        </section>
        {% endif %}

        {% if attendance_report is not none %}
        <section class="report-table">
            <h3>Training Attendance Report</h3>
            {% if attendance_report %}
            <div class="report-actions">
                <form method="POST" action="{{ url_for('admin.download_report_pdf') }}" class="inline-form">
                    <input type="hidden" name="report_type" value="attendance">
                    <input type="hidden" name="date_from" value="{{ request.form.get('date_from', '') }}">
                    <input type="hidden" name="date_to" value="{{ request.form.get('date_to', '') }}">
                    {% for player_id in request.form.getlist('player_id') %}
                    <input type="hidden" name="player_id" value="{{ player_id }}">
                    {% endfor %}
                    {% for session_id in request.form.getlist('session_id') %}
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    {% endfor %}
                    <input type="hidden" name="team_id" value="{{ request.form.get('team_id', '') }}">
                    <button type="submit" class="btn solid btn-small">Download PDF</button>
                </form>
            </div>
            <div class="table-card">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Attended</th>
                            <th>Absent</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in attendance_report %}
                        <tr>
                            <td>{{ row.firstname }} {{ row.lastname }}</td>
                            <td>{{ row.attended }}</td>
                            <td>{{ row.absent }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="subtle">No results.</p>
            {% endif %}
        </section>
        {% endif %}
    </main>

    <style>
        .report-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0.75rem;
        }

        .inline-form {
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Remove number spinners for report filters */
        .reports-grid input[type="number"]::-webkit-outer-spin-button,
        .reports-grid input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .reports-grid input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Ensure select dropdowns show selected value properly */
        .reports-grid select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background: #fff;
            font-size: 0.9rem;
            color: #0f172a;
            cursor: pointer;
        }

        .reports-grid select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .reports-grid select option {
            color: #0f172a;
            background: #fff;
            padding: 0.5rem;
        }

        .reports-grid select option:checked {
            background: #3b82f6;
            color: #fff;
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Player search for Player Report
            const playerSearch = document.querySelector(".player-search");
            const playerRows = document.querySelectorAll(".player-checkbox-list .checkbox-line");
            if (playerSearch) {
                playerSearch.addEventListener("input", function (event) {
                    const query = (event.target.value || "").toLowerCase().trim();
                    playerRows.forEach(row => {
                        const haystack = (row.dataset.playerSearch || row.innerText || "").toLowerCase();
                        const match = !query || haystack.includes(query);
                        row.classList.toggle("is-hidden", !match);
                    });
                });
            }

            // Player search for Training Attendance Report
            const attendancePlayerSearch = document.querySelector(".attendance-player-search");
            const attendancePlayerRows = document.querySelectorAll(".attendance-player-checkbox-list .checkbox-line");
            if (attendancePlayerSearch) {
                attendancePlayerSearch.addEventListener("input", function (event) {
                    const query = (event.target.value || "").toLowerCase().trim();
                    attendancePlayerRows.forEach(row => {
                        const haystack = (row.dataset.attendancePlayerSearch || row.innerText || "").toLowerCase();
                        const match = !query || haystack.includes(query);
                        row.classList.toggle("is-hidden", !match);
                    });
                });
            }

        });
    </script>
</body>
</html>
